<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Остановки</title>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function (m, e, t, r, i, k, a) {
            m[i] = m[i] || function () {
                (m[i].a = m[i].a || []).push(arguments)
            };
            m[i].l = 1 * new Date();
            k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(k, a)
        })
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(51775679, "init", {
            id: 51775679,
            clickmap: true,
            trackLinks: true,
            accurateTrackBounce: true,
            webvisor: true
        });
    </script>
    <noscript>
        <div><img alt="" src="https://mc.yandex.ru/watch/51775679" style="position:absolute; left:-9999px;"/></div>
    </noscript>
    <!-- /Yandex.Metrika counter -->
    <link href="lib/css/bootstrap.css" rel="stylesheet">
    <script src="lib/js/jquery-3.3.1.js" type="text/javascript"></script>
    <script src="lib/js/bootstrap.js" type="text/javascript"></script>
    <script src="js/classifiers.js"></script>
    <script>

        let currentPage;
        let alphabeticalMap;

        function createTable() {
            let fullStops = JSON.parse(localStorage.getItem('fullStops'));
            if (fullStops && fullStops.length) {
                addStopsInTable(fullStops);
            } else {
                getFullStops(addStopsInTable);
            }
        }

        function addStopsInTable(stops) {
            alphabeticalMap = new Map();
            stops.sort((stop1, stop2) => {
                if (stop1.title.trim() < stop2.title.trim()) {
                    return -1;
                }
                if (stop1.title.trim() > stop2.title.trim()) {
                    return 1;
                }
                return 0;
            });
            $(stops).each(function (i, stop) {
                let firstLetter = stop.title.trim()[0];
                if (alphabeticalMap.get(firstLetter) === undefined) {
                    let value = [];
                    value.push(stop);
                    alphabeticalMap.set(firstLetter, value);
                } else {
                    alphabeticalMap.get(firstLetter).push(stop);
                }
            });
            clearPages();
            alphabeticalMap.forEach(function (value, key, map) {
                let li = '<li class="page-item"><a id="' + key + '" class="page-link"  href="#" onclick="selectPage(this.id);">' + key + '</a></li>';
                $('#pages').append(li);
            });
            currentPage = alphabeticalMap.keys().next().value;
            selectPage(currentPage);
        }

        function selectPage(firstLetter) {
            clearTable();
            $('#' + currentPage).parent().removeClass('active');
            currentPage = firstLetter;
            $('#' + firstLetter).parent().addClass('active');
            let stops = alphabeticalMap.get(firstLetter);
            stops.forEach(function (stop, i) {
                let row = '<tr>' +
                    '<td>' + stop.title + '</td>' +
                    '<td>' + stop.adjacentStreet + '</td>' +
                    '<td>' + stop.direction + '</td>' +
                    '<td>' + stop.busesMunicipal + '</td>' +
                    '<td>' + stop.busesCommercial + '</td>' +
                    '<td>' + stop.busesPrigorod + '</td>' +
                    '<td>' + stop.trams + '</td>' +
                    '<td>' + stop.trolleybuses + '</td>' +
                    '</tr>';
                $('#stops').append(row);
            });
        }

        function clearTable() {
            $('#stops').html('');
        }

        function clearPages() {
            $('#pages').html('');
        }

        function searchStops() {
            let searchInput = $('#searchInput');
            let searchString = searchInput.val().toLowerCase();
            searchInput.val('');
            let stops = JSON.parse(localStorage.getItem('fullStops'));
            if (stops && stops.length) {
                let searchResult = [];
                $(stops).each(function (i, stop) {
                    if (stop.title.toLowerCase().search(searchString) !== -1 ||
                        stop.adjacentStreet.toLowerCase().search(searchString) !== -1 ||
                        stop.direction.toLowerCase().search(searchString) !== -1 ||
                        (stop.busesMunicipal && stop.busesMunicipal.length && stop.busesMunicipal.includes(searchString)) ||
                        (stop.busesCommercial && stop.busesCommercial.length && stop.busesCommercial.includes(searchString)) ||
                        (stop.busesPrigorod && stop.busesPrigorod.length && stop.busesPrigorod.includes(searchString)) ||
                        (stop.trams && stop.trams.length && stop.trams.includes(searchString)) ||
                        (stop.trolleybuses && stop.trolleybuses.length && stop.trolleybuses.includes(searchString))) {
                        searchResult.push(stop);
                    }
                });
                clearTable();
                addStopsInTable(searchResult);
            }
        }

    </script>
</head>
<body onload="createTable()">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <a class="navbar-brand" href="#">TransportRouter</a>
    <button aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
            class="navbar-toggler"
            data-target="#navbarSupportedContent" data-toggle="collapse" type="button">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="index.html">Главная</a>
            </li>
            <li class="nav-item dropdown active">
                <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown"
                   href="#" id="navbarDropdownMenuLink">
                    Справочники
                </a>
                <div aria-labelledby="navbarDropdownMenuLink" class="dropdown-menu">
                    <a class="dropdown-item active" href="#">Остановки</a>
                    <a class="dropdown-item" href="routes.html">Маршруты</a>
                </div>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="arrival.html">Данные о прибытии</a>
            </li>
        </ul>
    </div>
    <form class="form-inline">
        <input class="form-control mr-sm-2" type="search" placeholder="Поиск остановки" id="searchInput">
        <button class="btn btn-outline-light my-2 my-sm-0" type="button" onclick="searchStops();$(this).blur()">Поиск
        </button>
    </form>
</nav>
<nav>
    <div class="d-flex justify-content-center">
        <ul class="pagination p-2" id="pages"></ul>
    </div>
</nav>
<table class="table table-striped">
    <thead class="thead-light">
    <tr>
        <th scope="col">Остановка</th>
        <th scope="col">Улица</th>
        <th scope="col">Направление</th>
        <th scope="col">Муниципальные автобусы</th>
        <th scope="col">Коммерческие автобусы</th>
        <th scope="col">Пригородные автобусы</th>
        <th scope="col">Трамваи</th>
        <th scope="col">Троллейбусы</th>
    </tr>
    </thead>
    <tbody id="stops"></tbody>
</table>
</body>
</html>